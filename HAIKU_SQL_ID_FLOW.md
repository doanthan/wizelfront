# Haiku SQL Query: ID Conversion Flow

## üéØ Quick Answer

**Yes, Haiku uses `klaviyo_public_id` to query ClickHouse, NOT `store_public_id`.**

The system automatically converts:
```
store_public_id (from user) ‚Üí klaviyo_public_id (for ClickHouse)
```

## üîÑ Complete Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User asks:              ‚îÇ
‚îÇ  "How is Acme going?"    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Store Name Resolution                   ‚îÇ
‚îÇ  /lib/ai/store-resolver.js              ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  "Acme" ‚Üí Finds Store document:         ‚îÇ
‚îÇ  {                                       ‚îÇ
‚îÇ    public_id: "XAeU8VL",          ‚Üê UI ID
‚îÇ    name: "Acme Store",                   ‚îÇ
‚îÇ    klaviyo_integration: {                ‚îÇ
‚îÇ      public_id: "XqkVGb"          ‚Üê DB ID
‚îÇ    }                                     ‚îÇ
‚îÇ  }                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚îÇ Returns: storeIds = ["XAeU8VL"]
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AI Chat Route                           ‚îÇ
‚îÇ  /app/api/chat/ai/route.js              ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Tier 2: SQL Analysis                   ‚îÇ
‚îÇ  - storeIds: ["XAeU8VL"]                 ‚îÇ
‚îÇ  - Passes to: /api/ai/analyze           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚îÇ POST { storeIds: ["XAeU8VL"] }
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Tier 2 SQL Analysis Route               ‚îÇ
‚îÇ  /app/api/ai/analyze/route.js           ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Line 79-87: ID CONVERSION               ‚îÇ
‚îÇ  const { klaviyoIds } =                  ‚îÇ
‚îÇ    await storeIdsToKlaviyoIds(storeIds); ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  ["XAeU8VL"] ‚Üí ["XqkVGb"]               ‚îÇ
‚îÇ                  ‚Üë                        ‚îÇ
‚îÇ         This is the Klaviyo ID!          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚îÇ klaviyoIds = ["XqkVGb"]
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Haiku SQL Generation                    ‚îÇ
‚îÇ  /lib/ai/haiku-sql.js                    ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  generateSQL(question, klaviyoIds)      ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Haiku receives:                         ‚îÇ
‚îÇ  - Question: "How is Acme going?"       ‚îÇ
‚îÇ  - Klaviyo IDs: ["XqkVGb"]             ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Haiku generates SQL:                    ‚îÇ
‚îÇ  "SELECT * FROM account_metrics_daily   ‚îÇ
‚îÇ   WHERE klaviyo_public_id = 'XqkVGb'"  ‚îÇ
‚îÇ                  ‚Üë                       ‚îÇ
‚îÇ         Uses Klaviyo ID!                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚îÇ SQL with klaviyo_public_id
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ClickHouse Database                     ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Table: account_metrics_daily            ‚îÇ
‚îÇ  Columns:                                ‚îÇ
‚îÇ  - klaviyo_public_id (String)           ‚îÇ
‚îÇ  - date (Date)                           ‚îÇ
‚îÇ  - total_revenue (Float64)               ‚îÇ
‚îÇ  - total_orders (Int64)                  ‚îÇ
‚îÇ  ...                                     ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Query matches rows where:               ‚îÇ
‚îÇ  klaviyo_public_id = 'XqkVGb'          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚îÇ Returns historical data
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Results with Acme Store's data          ‚îÇ
‚îÇ  [                                       ‚îÇ
‚îÇ    { date: '2025-01-01',                 ‚îÇ
‚îÇ      klaviyo_public_id: 'XqkVGb',       ‚îÇ
‚îÇ      total_revenue: 12500,               ‚îÇ
‚îÇ      total_orders: 45 },                 ‚îÇ
‚îÇ    { date: '2025-01-02', ... },          ‚îÇ
‚îÇ    ...                                   ‚îÇ
‚îÇ  ]                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîë Two ID Types

### 1. `store_public_id` (UI/Frontend)

**What it is:** Internal store identifier
**Format:** 7-character nanoid (e.g., `XAeU8VL`)
**Used in:**
- ‚úÖ URLs: `/store/XAeU8VL/dashboard`
- ‚úÖ localStorage: `analyticsSelectedAccounts`
- ‚úÖ UI components: Store selector dropdowns
- ‚úÖ MongoDB queries: Finding Store documents
- ‚úÖ User permissions: `user.store_ids`

**Example:**
```javascript
{
  value: "XAeU8VL",      // ‚Üê store_public_id
  label: "Acme Store"
}
```

### 2. `klaviyo_public_id` (Database/Analytics)

**What it is:** Klaviyo account identifier
**Format:** Variable length string (e.g., `XqkVGb`)
**Used in:**
- ‚úÖ ClickHouse queries: ALL analytics tables
- ‚úÖ MongoDB analytics: `campaignstats`, `flowstats`, etc.
- ‚úÖ Klaviyo API calls: Account identification
- ‚úÖ Multi-tenant data: Multiple stores can share same Klaviyo ID

**Example:**
```javascript
{
  store_public_id: "XAeU8VL",
  klaviyo_integration: {
    public_id: "XqkVGb"   // ‚Üê klaviyo_public_id
  }
}
```

## üîÑ ID Conversion Process

### Step 1: User Selection ‚Üí Store Public IDs

```javascript
// User selects stores in UI
const selectedStores = [
  { value: "XAeU8VL", label: "Acme Store" },
  { value: "7MP60fH", label: "Store B" }
];

// These are store_public_ids
const storeIds = ["XAeU8VL", "7MP60fH"];
```

### Step 2: Store Public IDs ‚Üí Klaviyo Public IDs

**Location:** `/lib/utils/id-mapper.js:20`

```javascript
import { storeIdsToKlaviyoIds } from '@/lib/utils/id-mapper';

// Convert store IDs to Klaviyo IDs
const { klaviyoIds, storeMap } = await storeIdsToKlaviyoIds(storeIds);

// Result:
// klaviyoIds = ["XqkVGb", "Pe5Xw6"]
// storeMap = Map {
//   "XAeU8VL" => { klaviyo_public_id: "XqkVGb", store_name: "Acme Store" },
//   "7MP60fH" => { klaviyo_public_id: "Pe5Xw6", store_name: "Store B" }
// }
```

### Step 3: Klaviyo IDs ‚Üí ClickHouse Query

**Location:** `/lib/ai/haiku-sql.js`

```javascript
// Haiku generates SQL using Klaviyo IDs
const sql = await generateSQL(question, klaviyoIds);

// Generated SQL:
// "SELECT * FROM campaign_statistics
//  WHERE klaviyo_public_id IN ('XqkVGb', 'Pe5Xw6')
//  AND date >= '2025-01-01'"
```

## üìä ClickHouse Table Structure

All ClickHouse tables use `klaviyo_public_id`:

```sql
-- Table: account_metrics_daily
CREATE TABLE account_metrics_daily (
  klaviyo_public_id String,  -- ‚Üê This is the Klaviyo ID
  date Date,
  total_revenue Float64,
  total_orders Int64,
  ...
) ENGINE = MergeTree()
ORDER BY (klaviyo_public_id, date);

-- Example data:
-- klaviyo_public_id | date       | total_revenue | total_orders
-- XqkVGb           | 2025-01-01 | 12500.00      | 45
-- XqkVGb           | 2025-01-02 | 13200.00      | 48
-- Pe5Xw6           | 2025-01-01 | 8900.00       | 32
```

## üîç Why Two Different IDs?

### Reason 1: Multi-Tenant Architecture

**Multiple stores can share the same Klaviyo account:**

```javascript
Store 1:
{
  public_id: "XAeU8VL",
  name: "Acme Store - Main",
  klaviyo_integration: { public_id: "XqkVGb" }
}

Store 2:
{
  public_id: "7MP60fH",
  name: "Acme Store - Outlet",
  klaviyo_integration: { public_id: "XqkVGb" }  // ‚Üê Same Klaviyo account!
}
```

Both stores query the same ClickHouse data (`XqkVGb`).

### Reason 2: UI vs Analytics Separation

- **UI Layer**: Uses `store_public_id` for routing, permissions, display
- **Analytics Layer**: Uses `klaviyo_public_id` for data queries

This allows:
- Different store pages to show same analytics
- Easy store rebranding without data migration
- Flexible permission management

## üí° Key Insights

### 1. **Haiku Never Sees store_public_id**

```javascript
// ‚ùå Haiku does NOT receive:
generateSQL(question, ["XAeU8VL", "7MP60fH"]);

// ‚úÖ Haiku receives:
generateSQL(question, ["XqkVGb", "Pe5Xw6"]);
```

### 2. **Conversion Happens Before Haiku**

```javascript
// Flow:
User query ‚Üí Store resolution ‚Üí storeIds
          ‚Üì
   ID conversion (storeIdsToKlaviyoIds)
          ‚Üì
   klaviyoIds ‚Üí Haiku SQL generation
          ‚Üì
   ClickHouse query with klaviyo_public_id
```

### 3. **ClickHouse Only Has Klaviyo IDs**

```sql
-- ‚úÖ This works:
SELECT * FROM campaign_statistics
WHERE klaviyo_public_id = 'XqkVGb';

-- ‚ùå This fails (column doesn't exist):
SELECT * FROM campaign_statistics
WHERE store_public_id = 'XAeU8VL';
```

## üß™ Example: Complete Query Flow

### User Query: "What are my top campaigns last month for Acme Store?"

**Step 1: Store Name Resolution**
```javascript
"Acme Store" ‚Üí Store document ‚Üí public_id: "XAeU8VL"
```

**Step 2: ID Conversion**
```javascript
storeIds: ["XAeU8VL"]
    ‚Üì
storeIdsToKlaviyoIds(["XAeU8VL"])
    ‚Üì
klaviyoIds: ["XqkVGb"]
```

**Step 3: Haiku SQL Generation**
```javascript
generateSQL("What are my top campaigns last month", ["XqkVGb"])
    ‚Üì
Generated SQL:
"SELECT
   campaign_name,
   total_revenue,
   open_rate
 FROM campaign_statistics
 WHERE klaviyo_public_id = 'XqkVGb'
   AND date >= '2024-12-01'
   AND date < '2025-01-01'
 ORDER BY total_revenue DESC
 LIMIT 10"
```

**Step 4: ClickHouse Execution**
```javascript
// Query returns rows matching klaviyo_public_id = 'XqkVGb'
[
  { campaign_name: "Holiday Sale", total_revenue: 25000, open_rate: 28.5 },
  { campaign_name: "Welcome Series", total_revenue: 18000, open_rate: 32.1 },
  ...
]
```

**Step 5: Result Analysis**
```javascript
// Sonnet analyzes results and returns:
"Your top campaigns for Acme Store last month were:

1. Holiday Sale - $25K revenue, 28.5% open rate
2. Welcome Series - $18K revenue, 32.1% open rate
..."
```

## üìç Code Locations

### ID Conversion
- **File:** `/lib/utils/id-mapper.js:20`
- **Function:** `storeIdsToKlaviyoIds()`

### Used in Tier 2 Analysis
- **File:** `/app/api/ai/analyze/route.js:79`
- **Line:** `const { klaviyoIds } = await storeIdsToKlaviyoIds(targetStoreIds);`

### Passed to Haiku
- **File:** `/app/api/ai/analyze/route.js:98`
- **Line:** `const sqlResult = await generateSQL(question, klaviyoIds, options);`

### Haiku SQL Generation
- **File:** `/lib/ai/haiku-sql.js`
- **Receives:** `klaviyoIds` array
- **Generates:** SQL with `klaviyo_public_id IN (...)` clause

## ‚úÖ Summary

| Step | Input | Process | Output |
|------|-------|---------|--------|
| 1. Store Selection | "Acme Store" | Name resolution | `store_public_id` |
| 2. ID Conversion | `["XAeU8VL"]` | `storeIdsToKlaviyoIds()` | `["XqkVGb"]` |
| 3. SQL Generation | `klaviyoIds` | Haiku AI | SQL with `klaviyo_public_id` |
| 4. Query Execution | SQL | ClickHouse | Historical data |

**Key Points:**
- ‚úÖ **Haiku uses `klaviyo_public_id`** for ClickHouse queries
- ‚úÖ **Conversion happens automatically** before Haiku
- ‚úÖ **ClickHouse tables only have `klaviyo_public_id`** column
- ‚úÖ **Multiple stores can share same Klaviyo ID**
- ‚úÖ **System handles conversion transparently**

üöÄ **The ID conversion is already fully implemented and working!**
